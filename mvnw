#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements. See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership. The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License. You may obtain a copy of the License at
#
# https://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied. See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
 [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
 native_path() { cygpath --path --windows "$1"; }
 ;;
esac

# set JAVACMD and JAVACCMD
set_java_home() {
 if [ -n "${JAVA_HOME-}" ]; then
   if [ -x "$JAVA_HOME/jre/sh/java" ]; then
     JAVACMD="$JAVA_HOME/jre/sh/java"
     JAVACCMD="$JAVA_HOME/jre/sh/javac"
   else
     JAVACMD="$JAVA_HOME/bin/java"
     JAVACCMD="$JAVA_HOME/bin/javac"
   fi
   if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
     echo "The JAVA_HOME environment variable is not defined correctly." >&2
     return 1
   fi
 else
   JAVACMD="$(command -v java 2>/dev/null)" || :
   JAVACCMD="$(command -v javac 2>/dev/null)" || :
   if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
     echo "The java/javac command does not exist in PATH nor is JAVA_HOME set." >&2
     return 1
   fi
 fi
}

hash_string() {
 str="${1:-}" h=0
 while [ -n "$str" ]; do
   char="${str%"${str#?}"}"
   h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
   str="${str#?}"
 done
 printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" = true ] && verbose() { printf %s\\n "${1-}"; }

die() {
 printf %s\\n "$1" >&2
 exit 1
}

trim() {
 printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(cd "$(dirname "$0")" && pwd)"
scriptName="$(basename "$0")"

while IFS="=" read -r key value; do
 case "${key-}" in
   distributionUrl) distributionUrl=$(trim "${value-}") ;;
   distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
 esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"
[ -n "${distributionUrl-}" ] || die "cannot read distributionUrl in maven-wrapper.properties"

case "${distributionUrl##*/}" in
  maven-mvnd-*bin.*) MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/ ;;
  *) MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/ ;;
esac

[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"
distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"
MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain-}/$(hash_string "$distributionUrl")"

exec_maven() {
 unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL 2>/dev/null || true
 exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec $MAVEN_HOME/bin/$MVN_CMD"
}

[ -d "$MAVEN_HOME" ] && exec_maven "$@"

case "${distributionUrl-}" in
  *?-bin.zip | *?maven-mvnd-?*-?*.zip) ;;
  *) die "distributionUrl must match *-bin.zip, found '${distributionUrl-}'" ;;
esac

TMP_DOWNLOAD_DIR="$(mktemp -d)" || die "cannot create temp dir"
clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
trap clean HUP INT TERM EXIT

mkdir -p -- "${MAVEN_HOME%/*}"
verbose "Downloading Maven from: $distributionUrl"

__MVNW_QUIET_WGET=--quiet __MVNW_QUIET_CURL=--silent __MVNW_QUIET_UNZIP=-q
[ "${MVNW_VERBOSE-}" = true ] && __MVNW_QUIET_WGET='' __MVNW_QUIET_CURL='' __MVNW_QUIET_UNZIP=''

if [ -z "${MVNW_USERNAME-}" ] && command -v wget >/dev/null; then
 wget ${__MVNW_QUIET_WGET:+"$__MVNW_QUIET_WGET"} "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName" || die "wget failed"
elif [ -z "${MVNW_USERNAME-}" ] && command -v curl >/dev/null; then
 curl ${__MVNW_QUIET_CURL:+"$__MVNW_QUIET_CURL"} -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl" || die "curl failed"
elif set_java_home 2>/dev/null; then
 javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
 targetZip="$TMP_DOWNLOAD_DIR/$distributionUrlName"
 cat >"$javaSource" <<'END'
import java.net.*;
import java.nio.file.*;
public class Downloader extends java.net.Authenticator {
  protected java.net.PasswordAuthentication getPasswordAuthentication() {
    return new java.net.PasswordAuthentication(System.getenv("MVNW_USERNAME"), System.getenv("MVNW_PASSWORD").toCharArray());
  }
  public static void main(String[] args) throws Exception {
    Authenticator.setDefault(new Downloader());
    Files.copy(URI.create(args[0]).toURL().openStream(), Paths.get(args[1]));
  }
}
END
 "$JAVACCMD" "$javaSource" -d "$TMP_DOWNLOAD_DIR" || die "compile failed"
 "$JAVACMD" -cp "$TMP_DOWNLOAD_DIR" Downloader "$distributionUrl" "$(cd "$(dirname "$targetZip")" && pwd)/$(basename "$targetZip")" || die "download failed"
else
 die "Need wget, curl or Java to download Maven"
fi

if [ -n "${distributionSha256Sum-}" ]; then
 if command -v sha256sum >/dev/null; then
   echo "$distributionSha256Sum $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - || die "SHA-256 validation failed"
 elif command -v shasum >/dev/null; then
   echo "$distributionSha256Sum $TMP_DOWNLOAD_DIR/$distributionUrlName" | shasum -a 256 -c - || die "SHA-256 validation failed"
 fi
fi

command -v unzip >/dev/null && unzip ${__MVNW_QUIET_UNZIP:+"$__MVNW_QUIET_UNZIP"} "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR" || tar xzf "$TMP_DOWNLOAD_DIR/$distributionUrlName" -C "$TMP_DOWNLOAD_DIR" || die "extract failed"

actualDistributionDir=""
[ -d "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain" ] && [ -f "$TMP_DOWNLOAD_DIR/$distributionUrlNameMain/bin/$MVN_CMD" ] && actualDistributionDir="$distributionUrlNameMain"
if [ -z "$actualDistributionDir" ]; then
  for dir in "$TMP_DOWNLOAD_DIR"/*/; do
    [ -f "${dir}bin/$MVN_CMD" ] && actualDistributionDir="$(basename "$dir")" && break
  done
fi
[ -z "$actualDistributionDir" ] && die "Could not find Maven in extracted archive"

printf %s\\n "$distributionUrl" >"$TMP_DOWNLOAD_DIR/$actualDistributionDir/mvnw.url"
mv -- "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME" || [ -d "$MAVEN_HOME" ] || die "fail to move MAVEN_HOME"

clean 2>/dev/null || true
exec_maven "$@"
